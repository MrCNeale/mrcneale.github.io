<!doctype html><html lang=en-us><head><title>ESXi and AD Part 1 - Integration Checklist // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="ESXi and AD Part 1 - Integration Checklist"><meta name=twitter:description content="This first post is to run through common issues that are simple and &ldquo;reasonable&rdquo; to presume the end-user/sysadmin has checked first
Firewall ports on the ESXi Host. I&rsquo;m going to presume host and AD are on the same subnet, if not then you are responsible for checking routing and firewalls between Host and AD Domain Controllers are configure correctly Port 88 - Kerberos authentication
Port 123 – NTP
Port 135 - RPC"><meta property="og:title" content="ESXi and AD Part 1 - Integration Checklist"><meta property="og:description" content="This first post is to run through common issues that are simple and &ldquo;reasonable&rdquo; to presume the end-user/sysadmin has checked first
Firewall ports on the ESXi Host. I&rsquo;m going to presume host and AD are on the same subnet, if not then you are responsible for checking routing and firewalls between Host and AD Domain Controllers are configure correctly Port 88 - Kerberos authentication
Port 123 – NTP
Port 135 - RPC"><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2015-11-30-esxi-ad-integration-checklist/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-11-30T00:00:00+00:00"><meta property="article:modified_time" content="2015-11-30T00:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/images/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>ESXi and AD Part 1 - Integration Checklist</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Nov 30, 2015</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div></div></header><div class=post-content><p>This first post is to run through common issues that are simple and &ldquo;reasonable&rdquo; to presume the end-user/sysadmin has checked first</p><ul><li>Firewall ports on the ESXi Host. I&rsquo;m going to presume host and AD are on the same subnet, if not then you are responsible for checking routing and firewalls between Host and AD Domain Controllers are configure correctly</li></ul><p>Port 88 - Kerberos authentication</p><p>Port 123 – NTP</p><p>Port 135 - RPC</p><p>Port 137 - NetBIOS Name Service</p><p>Port 139 - NetBIOS Session Service (SMB)</p><p>Port 389 - LDAP</p><p>Port 445 - Microsoft-DS Active Directory, Windows shares (SMB over TCP)</p><p>Port 464 - Kerberos - change/password changes</p><p>Port 3268 - Global Catalog search</p><p>This KB lists the ports for ESXi 4.1 If you have these open it should be fine for higher ESXi versions too</p><p><a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1026538#src=vmwsovexcneal_850">AD Ports required in ESXi</a></p><p><a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1012382#ESXi5x#src=vmwsovexcneal_850">All ESXi 5.x ports</a></p><p><a href=https://technet.microsoft.com/en-us/library/dd772723(WS.10).aspx>All Port requirements from Microsoft</a></p><ul><li>Time Sync. Your hosts should be synced to the same source as your Domain Controllers<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Get</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHost</span> <span style=color:#f92672>-</span><span style=color:#66d9ef>VMHost</span> $esx <span style=color:#f92672>|</span> <span style=color:#66d9ef>Add</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VmHostNtpServer</span>  <span style=color:#f92672>-</span><span style=color:#66d9ef>NtpServer</span> servername
</span></span><span style=display:flex><span><span style=color:#66d9ef>Get</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHostFirewallException</span> <span style=color:#f92672>-</span><span style=color:#66d9ef>VMHost</span> $esx <span style=color:#f92672>|</span> where {$_<span style=color:#f92672>.</span>Name <span style=color:#f92672>-</span>eq <span style=color:#e6db74>&#34;NTP client&#34;</span>} <span style=color:#f92672>|</span> <span style=color:#66d9ef>Set</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHostFirewallException</span> <span style=color:#f92672>-</span><span style=color:#e6db74>Enabled</span>:$true
</span></span><span style=display:flex><span><span style=color:#66d9ef>Get</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VmHostService</span> <span style=color:#f92672>-</span><span style=color:#66d9ef>VMHost</span> $esx <span style=color:#f92672>|</span> <span style=color:#66d9ef>Where</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> {$_<span style=color:#f92672>.</span>key <span style=color:#f92672>-</span>eq <span style=color:#e6db74>&#34;ntpd&#34;</span>} <span style=color:#f92672>|</span> <span style=color:#66d9ef>Start</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHostService</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Get</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VmHostService</span> <span style=color:#f92672>-</span><span style=color:#66d9ef>VMHost</span> $esx <span style=color:#f92672>|</span> <span style=color:#66d9ef>Where</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> {$_<span style=color:#f92672>.</span>key <span style=color:#f92672>-</span>eq <span style=color:#e6db74>&#34;ntpd&#34;</span>} <span style=color:#f92672>|</span> <span style=color:#66d9ef>Set</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHostService</span> <span style=color:#f92672>-</span>policy <span style=color:#e6db74>&#34;automatic&#34;</span></span></span></code></pre></div></li><li>Permissions of the AD user you are using to join the domain. If you&rsquo;re unlucky enough to not have a domain admin account to do the join then you&rsquo;ll need to ensure that the AD user account user account you are using has the following rights delegated to it on the OU where you are creating or updating, if it&rsquo;s been prestaged, the computer account.<ol><li>Reset Password</li><li>Read and write Account Restrictions</li><li>Validated write to DNS host name</li><li>Validated write to service principal name</li><li>Create/Delete Computer Objects</li></ol></li><li>DNS. Your host should either use the AD DNS servers or be pointed to a DNS server with a conditional forwarder to the AD integrated DNS. Your host should have a record in that DNS pre-created ideally. An nslookup from your hosts console should return all the DCs if you simply do</li></ul><p>nslookup mydomain.com mydnsserver.mydomain.com</p><p>this should return the list of DCs</p><p>If you&rsquo;ve ticked all those boxes then it should work. I&rsquo;m guessing if you&rsquo;re reading this then it hasn&rsquo;t. Part 2 shortly to follow will go through troubleshooting AD&ESXi which don&rsquo;t seem to play well if anything differs from a very vanilla environment.</p></div><div class=post-footer></div></article></main></body></html>