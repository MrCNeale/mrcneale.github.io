<!doctype html><html lang=en-us><head><title>ESXi and AD Part 2 Joining a Domain without Domain Admin Privileges // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=https://www.chrisneale.org/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="ESXi and AD Part 2 Joining a Domain without Domain Admin Privileges"><meta name=twitter:description content="Problem You need to join an ESXi host to AD but you do not have Domain Admins. Your AD team ask what rights ESXi requires and you can&rsquo;t tell them VMware Support give you a stock &ldquo;You must have Domain Admins&rdquo; reply to a support call. Solution Delegate the rights as per the following Microsoft KB Article https://support.microsoft.com/en-us/kb/932455 &mldr;yes I know it&rsquo;s for 2003 but AD hasn&rsquo;t changed that much since then&mldr;shhh don&rsquo;t tell!"><meta property="og:title" content="ESXi and AD Part 2 Joining a Domain without Domain Admin Privileges"><meta property="og:description" content="Problem You need to join an ESXi host to AD but you do not have Domain Admins. Your AD team ask what rights ESXi requires and you can&rsquo;t tell them VMware Support give you a stock &ldquo;You must have Domain Admins&rdquo; reply to a support call. Solution Delegate the rights as per the following Microsoft KB Article https://support.microsoft.com/en-us/kb/932455 &mldr;yes I know it&rsquo;s for 2003 but AD hasn&rsquo;t changed that much since then&mldr;shhh don&rsquo;t tell!"><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2015-12-13-esxi-and-ad-part-2-joining-a-domain-without-domain-admin-privileges/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-12-13T18:00:00+00:00"><meta property="article:modified_time" content="2015-12-13T18:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>ESXi and AD Part 2 Joining a Domain without Domain Admin Privileges</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Dec 13, 2015</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://www.chrisneale.org/tags/esxi/>esxi</a>
<a class=tag href=https://www.chrisneale.org/tags/vmware/>VMware</a></div></div></header><div class=post-content><h2 id=problem>Problem</h2><ul><li>You need to join an ESXi host to AD but you do not have Domain Admins.</li><li>Your AD team ask what rights ESXi requires and you can&rsquo;t tell them</li><li>VMware Support give you a stock &ldquo;You must have Domain Admins&rdquo; reply to a support call.</li></ul><h2 id=solution>Solution</h2><ul><li>Delegate the rights as per the following Microsoft KB Article
<a href=https://support.microsoft.com/en-us/kb/932455>https://support.microsoft.com/en-us/kb/932455</a>
&mldr;yes I know it&rsquo;s for 2003 but AD hasn&rsquo;t changed that much since then&mldr;shhh don&rsquo;t tell!</li><li>Also Delegate <strong>Read All Properties</strong> and <strong>Write All Properties</strong></li><li>Your OU permissions should look like this now (Tenant1Admin is the Account Mr Domain Admin has given you) <img src=/images/sshot1.PNG alt="OU Permissions" title="OU Permissions"></li></ul><p>The latter was the key to getting ESXi to be able to update random fields in the Computer Object such as <em>OperatingSystemServicePack</em> which VMware/Likewise decided to populate with <em>Likewise Identity 5.3.0</em>!
For background info and other reasons you might be stuck, read on&mldr;&mldr;..</p><h2 id=the-storydiagnosis--how-to-troubleshoot-esxiadlikewise-logs>The story/diagnosis & how to troubleshoot ESXi/AD/Likewise logs</h2><p>I have an e-mail from VMware support stating the following</p><p>&ldquo;I&rsquo;ve discussed this issue with my escalation engineer&rsquo;s.</p><p>To add/join the ESXi host to AD you need to have a Domain Admin privilege.</p><p>This email can be considered to be an official document, however if you have any more queries, please reply back to this email."</p><p>This is beyond disappointing. It means that they don&rsquo;t know or care how AD works and are not serious about supporting it as an Identity Provider.</p><p>In the environment I&rsquo;m working in I am not getting Domain Admins any time soon, and rightly so as it&rsquo;s a sledgehammer to crack a nut!</p><p>I started off using this slightly outdated article from Microsoft on how to delegate rights to a user to allow them to join computers to a domain</p><p><a href=https://support.microsoft.com/en-us/kb/932455>https://support.microsoft.com/en-us/kb/932455</a></p><p>This lists how to delegate Creation and Deletion of Computer Objects to an OU and 4 permissions required to complete a domain join. This works fine for Windows Hosts and Redhat Linux hosts joining using sssd. But ESXi&rsquo;s Likewise/Netlogon domain join borks at these permissions and throws either</p><p>&ldquo;Errors in Active Directory operations&rdquo; (An error so useless, yes frequent it should have it&rsquo;s own Twitter account!)</p><p>There are a vast array of reasons why ESXi might throw this, but presuming you followed Part 1 of this blog topic then the reason you are seeing it is because you don&rsquo;t have enough permissions in AD&mldr;&mldr;&mldr;..yet</p><p>The next step was to find out what ESXi/Likewise REALLY needs (seeing as Support don&rsquo;t know or won&rsquo;t tell). So if you go into a DC in a test lab and either use the domain admin or delegate full control over the OU to your test user
then you can:</p><h2 id=enable-advanced-audit-logging>Enable advanced audit logging</h2><ol><li>First select Properties of the OU you are trying to add Computers to</li><li>Go to the security tab and click Advanced Button/Auditing Tab/Add</li><li>In <em>Security Principal</em> at the top click and select the user who is going to be adding (or trying to add) a host to the domain</li><li>Change Type=All, Applies to=This Object and All Descendant Objects and tick Full Control in the Permissions section</li><li>Now go to the Default Domain Controller Policy in GPMC and edit the policy</li><li>Navigate to Computer Configuration/Windows Settings/Security Settings/Advanced Audit Policy Configuration/Audit Policies/DS Access</li><li>Change Audit Directory Service Access to Configured for Success/Fail</li><li>Change Audit Directory Service Change to Configured for Success/Fail</li></ol><p>Now if you clear your test.lab DC&rsquo;s security logs and try and join your ESXi host then you can see exactly which attributes and actions the ESXi host is trying to do when joining the domain.</p><h2 id=enable-likewise-logging>Enable Likewise Logging</h2><ol><li>Follow this VMware KB <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1026554#src=vmwsovexcneal_850">http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1026554</a></li><li>Now go and browse /var/log or /scratch/log for <em>netlogond.log</em>,<em>lwiod.log</em> and <em>lsassd.log</em> and happy trawling</li></ol><h2 id=restarting-the-likewisenetlogon-daemons-from-powercli>Restarting The Likewise/Netlogon Daemons from Powercli</h2><p>Connect to your vCenter or ESXi host and run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Get</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHost</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Get</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHostService</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>?{</span><span style=color:#e6db74>&#34;lsassd&#34;</span>,<span style=color:#e6db74>&#34;lwiod&#34;</span>,<span style=color:#e6db74>&#34;netlogond&#34;</span> <span style=color:#f92672>-</span>contains $_<span style=color:#f92672>.</span>Key} <span style=color:#f92672>|</span> <span style=color:#66d9ef>Restart</span><span style=color:#f92672>-</span><span style=color:#66d9ef>VMHostService</span></span></span></code></pre></div></div><div class=post-footer></div></article></main></body></html>