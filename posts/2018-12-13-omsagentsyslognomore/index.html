<!doctype html><html lang=en-us><head><title>OMS Agent Syslogs Not Collecting // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="OMS Agent Syslogs Not Collecting"><meta name=twitter:description content="We use Log Analytics to collect logs so that we can query the pooled logs to generate alerts. A common scenario. We had an ARM template that had worked for a long time, but when we had an issue, the first thing Microsoft said was &ldquo;Why are you using such an old version?&rdquo; Ok, we&rsquo;d missed the agent updates on this particular template for Linux, it&rsquo;s always best to be up to date."><meta property="og:title" content="OMS Agent Syslogs Not Collecting"><meta property="og:description" content="We use Log Analytics to collect logs so that we can query the pooled logs to generate alerts. A common scenario. We had an ARM template that had worked for a long time, but when we had an issue, the first thing Microsoft said was &ldquo;Why are you using such an old version?&rdquo; Ok, we&rsquo;d missed the agent updates on this particular template for Linux, it&rsquo;s always best to be up to date."><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2018-12-13-omsagentsyslognomore/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-12-13T10:00:00+00:00"><meta property="article:modified_time" content="2018-12-13T10:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>OMS Agent Syslogs Not Collecting</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Dec 13, 2018</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://www.chrisneale.org/tags/azure/>Azure</a>
<a class=tag href=https://www.chrisneale.org/tags/template/>Template</a>
<a class=tag href=https://www.chrisneale.org/tags/automation/>Automation</a>
<a class=tag href=https://www.chrisneale.org/tags/monitoring/>Monitoring</a></div></div></header><div class=post-content><img style=float:top src=https://msdnshared.blob.core.windows.net/media/2016/11/OMS-Log-Analytics-e1479220299227.png><p>We use Log Analytics to collect logs so that we can query the pooled logs to generate alerts. A common scenario.
We had an ARM template that had worked for a long time, but when we had an issue, the first thing Microsoft said was &ldquo;Why are you using such an old version?&rdquo;
Ok, we&rsquo;d missed the agent updates on this particular template for Linux, it&rsquo;s always best to be up to date. So two things happened.</p><p>1 Setting Linux OMS agents to always deploy the latest version<br>Microsoft documentation can be hit and miss. Sometimes it&rsquo;s brilliant, other times it seems to miss the obvious. This is one such case.<br>Here is the Windows Docs page for the OMS/LogAnalytics agent ARM template syntax:<br><a href=https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-windows>https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-windows</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span><span style=color:#e6db74>&#34;properties&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;publisher&#34;</span>: <span style=color:#e6db74>&#34;Microsoft.EnterpriseCloud.Monitoring&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;MicrosoftMonitoringAgent&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;typeHandlerVersion&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;autoUpgradeMinorVersion&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span></code></pre></div><p>It shows a property named <em>AutoUpgradeMinorVersion</em> this little gem always selects the latest 1.x version to install whenever you deploy a template&mldr;It doesn&rsquo;t upgrade after install&mldr;that&rsquo;s a different issue.<br>Here is the Linux Docs page:<br><a href=https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux>https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/oms-linux</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>   <span style=color:#e6db74>&#34;properties&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;publisher&#34;</span>: <span style=color:#e6db74>&#34;Microsoft.EnterpriseCloud.Monitoring&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;OmsAgentForLinux&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;typeHandlerVersion&#34;</span>: <span style=color:#e6db74>&#34;1.7&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;settings&#34;</span>: {
</span></span></code></pre></div><p>But this doesn&rsquo;t show the property!</p><p>Ok so we got over that. New installs chugged along and we were getting OMS/LA agent 1.8 instead of 1.3. GREAT!<br>Except we hadn&rsquo;t checked the release notes to see what had changed.<br>When our automated testing ran, an alert that previously worked no longer fired when the condition it was supposed to detect occured.
This was odd. After looking at the alert, it was based on the contents of Syslog. Looking at the Log Anlaytics Workspace Logs area, we could see that no Syslog logs were being collected. Even more strange. But wait 1 VM was populating Syslog in OMS/LA. How was it doing that?</p><p>Have you guessed yet?<br>Here&rsquo;s a screenshot of our Workspace/Advanced Settings/Data/Syslog configuration to help. <img src=/images/emptylawsyslog.jpg>
Spot the deliberate mistake? Yep, syslog wasn&rsquo;t set to be collected.<br>Hang on a minute though, we hadn&rsquo;t changed our workspace config. I double checked the code to deploy our workspaces. It never enabled syslog collection. So how did this <em>EVER</em> work?<br><img style=float:top src=/public/confused.gif><br>Simple&mldr;it was a &ldquo;bug&rdquo;.<br>Checkout the release notes for a prior release of OMS agent:<br><a href=https://github.com/Microsoft/OMS-Agent-for-Linux/releases/tag/OMSAgent_GA_v1.4.3-174>https://github.com/Microsoft/OMS-Agent-for-Linux/releases/tag/OMSAgent_GA_v1.4.3-174</a><br>Bugfix = Disable Syslog data collection by default<br>So until v1.4.3 all Linux agents pushed syslog, whether you asked for it or not!</p><p>A simple update to the workspace code to make sure Syslog collection was enabled with correct facilities and all working.</p><p>Lesson for today. Always Read The Flippin Release Notes (RTFRN)
<img src=/images/rtfm.png></p></div><div class=post-footer></div></article></main></body></html>