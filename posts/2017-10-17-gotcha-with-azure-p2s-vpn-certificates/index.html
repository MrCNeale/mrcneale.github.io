<!doctype html><html lang=en-us><head><title>Gotcha when importing client certificates for Azure P2S VPN // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=https://www.chrisneale.org/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Gotcha when importing client certificates for Azure P2S VPN"><meta name=twitter:description content="After waiting 30 minutes for my P2S VPN gateway to deploy in Azure I was obviously eager to get VPN-ing, who wouldn't be! I ran through the instructions to generate a self-signed Root Cert and a client cert from Microsoft on this page [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-certificates-point-to-site](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-certificates-point-to-site) \*(Put a pin here, we'll come back to this) I'd imported the certs to my test client VM and the Client VPN setup exe ran ok and created a connection in &#34;"><meta property="og:title" content="Gotcha when importing client certificates for Azure P2S VPN"><meta property="og:description" content="After waiting 30 minutes for my P2S VPN gateway to deploy in Azure I was obviously eager to get VPN-ing, who wouldn't be! I ran through the instructions to generate a self-signed Root Cert and a client cert from Microsoft on this page [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-certificates-point-to-site](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-certificates-point-to-site) \*(Put a pin here, we'll come back to this) I'd imported the certs to my test client VM and the Client VPN setup exe ran ok and created a connection in &#34;"><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2017-10-17-gotcha-with-azure-p2s-vpn-certificates/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-10-17T22:00:00+00:00"><meta property="article:modified_time" content="2017-10-17T22:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Gotcha when importing client certificates for Azure P2S VPN</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Oct 17, 2017</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://www.chrisneale.org/tags/powershell/>PowerShell</a>
<a class=tag href=https://www.chrisneale.org/tags/security/>Security</a>
<a class=tag href=https://www.chrisneale.org/tags/scripting/>Scripting</a>
<a class=tag href=https://www.chrisneale.org/tags/azure/>Azure</a>
<a class=tag href=https://www.chrisneale.org/tags/p2svpn/>P2SVPN</a></div></div></header><div class=post-content><img style=float:right src=http://www.chrisneale.org/public/azurevpn.png>
After waiting 30 minutes for my P2S VPN gateway to deploy in Azure I was obviously eager to get VPN-ing, who wouldn't be!
I ran through the instructions to generate a self-signed Root Cert and a client cert from Microsoft on this page [https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-certificates-point-to-site](https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-certificates-point-to-site)
\*(Put a pin here, we'll come back to this)
I'd imported the certs to my test client VM and the Client VPN setup exe ran ok and created a connection in "Network Connections". I tried to connect and received an error<br><br>**A certificate could not be found that can be used with this Extensible Authentication Protocol. (Error 798)**<br><br><img style=float:left src=http://www.chrisneale.org/public/certerrror.png>
I foolishly didn't Google first and I checked the comments section at the bottom of the instructions. The Microsoft engineer referred to how they moved from MakeCert.exe to the new Powershell<p style=color:blue>New-SelfSignedCertificate</p>cmdlet. However, it became clear during testing and reading that the nice bod from Microsoft was using all the new things and not testing backward compatibility.
That's fine but they didn't initiall stipulate that this would only work for Windows 10/2016 clients.
A bit more digging and it turns out that the default import options for a cert **BEFORE** Windows 10/2016 enable "Strong Private Key Protection". That sounds like a good thing, but it actually means the OS prompts whenever the certificate (and it's private keys) are accessed. Which breaks the VPN client connection package.<p>So the simple solution is that:<br>When importing a VPN Client Cert and you are presented with the option to <em>&ldquo;Enable strong private key protection&rdquo;</em>, untick it. If you&rsquo;re on a newer OS, you won&rsquo;t get this prompt (tested on Server 2016). Now this is in the troubleshooting guide, but it should be in the instructions, rather than something you have to search for after the fact.
<a href=https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems>https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-troubleshoot-vpn-point-to-site-connection-problems</a></p><p>So RTFM, and also any related KBs&mldr;.and the TroubleShooting guide&mldr;.and you&rsquo;ll be fine</p></div><div class=post-footer></div></article></main></body></html>