<!doctype html><html lang=en-us><head><title>Using the Azure Load Balancer in reverse to funnel all outgoing traffic via a single IP // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Using the Azure Load Balancer in reverse to funnel all outgoing traffic via a single IP"><meta name=twitter:description content="An Odd Request This implementation started from a SAP team who said they wanted to replicate, in Azure, the AWS Internet Gateway functionality. In particular the option for all outbound traffic from VMs to route via a single outbound IP. As you may know even if your default Azure VM does not have a Public IP assigned to it, it can still access the internet for things like windows updates etc."><meta property="og:title" content="Using the Azure Load Balancer in reverse to funnel all outgoing traffic via a single IP"><meta property="og:description" content="An Odd Request This implementation started from a SAP team who said they wanted to replicate, in Azure, the AWS Internet Gateway functionality. In particular the option for all outbound traffic from VMs to route via a single outbound IP. As you may know even if your default Azure VM does not have a Public IP assigned to it, it can still access the internet for things like windows updates etc."><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2018-07-16-azurelbasinternetgateway/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-07-16T22:00:00+00:00"><meta property="article:modified_time" content="2018-07-16T22:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/images/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Using the Azure Load Balancer in reverse to funnel all outgoing traffic via a single IP</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jul 16, 2018</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://www.chrisneale.org/tags/powershell/>PowerShell</a>
<a class=tag href=https://www.chrisneale.org/tags/security/>Security</a>
<a class=tag href=https://www.chrisneale.org/tags/scripting/>Scripting</a>
<a class=tag href=https://www.chrisneale.org/tags/azure/>Azure</a>
<a class=tag href=https://www.chrisneale.org/tags/networking/>Networking</a>
<a class=tag href=https://www.chrisneale.org/tags/loadbalancer/>LoadBalancer</a></div></div></header><div class=post-content><img style=float:top src="https://azure.microsoft.com/svghandler/load-balancer/?width=600&height=315"><h2>An Odd Request</h2>This implementation started from a SAP team who said they wanted to replicate, in Azure, the AWS Internet Gateway functionality. In particular the option for all outbound traffic from VMs to route via a single outbound IP.<p>As you may know even if your default Azure VM does not have a Public IP assigned to it, it can still access the internet for things like windows updates etc. However when it does so the Public IP it appears to have come from is ephemeral and changes. Similarly each VM will have different IPs. For a reason known to the SAP team, they needed all VMs to appear to be coming from the same IP.</p><p>Obvious options are NVAs but they are quite big, cumbersome things to deploy and configure quickly and easily. They would also required ongoing changes, such as updating rules/IPs if a new VM is added.</p><p>That&rsquo;s when we found that the Azure Load Balancer can be used to &ldquo;Balance&rdquo; outgoing connections also.
<a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections#lb>The Microsoft Docs detail this behaviour here</a><br>By creating an LB with a public IP, then creating a dummy health probe to a non existent service, then connecting that, via a rule to a BackEnd Pool containing your VMs, any traffic that goes to the internet from those VMs will exit via the Public IP of the LB.</p><h2>Implementation Steps</h2>1. Create a Public IP (Or create one during load balancer creation)
2. Create a Load Balancer and associate with the Public IP from step 1 <img src=/images/LB1and2.png align=bottom>
3. Create a Health Probe, select a non used port on the VMs, say 65534 <img src=/images/LB3.png align=bottom>
4. Create an Availability Set <img src=/images/LB4.png align=bottom>
5. Create a BackEndPool with the availability set as the member <img src=/images/LB5.png align=bottom>
6. Create a LB Rule selecting your Public IP, Health Prob and BackEnd Pool you just created <img src=/images/LB6.png align=bottom><p>Here&rsquo;s the LB IP<br><img src=/images/LB-IP.png align=bottom><br>Here&rsquo;s the VM nic config, showing only a private IP<br><img src=/images/vmnicconf.png align=bottom><br>Then we find out what the internet thinks our IP is with this command:<br><img src=/images/ps-command.png align=bottom><br>And we see it matches the LB<br><img src=/images/wmip.png align=bottom></p><p>Now any VMs deployed to the Availability Set will automatically have their outbound traffic via the Public IP<br>If you already have VMs, or require more granular control over the IPs/Networks/VMs that are included, then at step #2 deploy a STANDARD SKU Load Balancer and do not deploy the availability set in step #4, as this allows more control over BackEnd Pool selection of members, but needs manual updating of the members.</p></div><div class=post-footer></div></article></main></body></html>