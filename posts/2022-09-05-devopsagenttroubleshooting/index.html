<!doctype html><html lang=en-us><head><title>How to Troubleshoot Azure Self-Hosted Devops Agent issues // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=https://www.chrisneale.org/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="How to Troubleshoot Azure Self-Hosted Devops Agent issues"><meta name=twitter:description content="Why Use Self-Hosted Agents for Devops jobs? We recently had issues with some Devops tasks queuing. This was happening only with the tasks in the job that we run on our self-hosted agents.
Why run our own agents? It&rsquo;s a reasonable question. Microsoft provide agents (VMs) pre-configured and ready to run your tasks for you, so why mess about setting up your own?
There is usually a problem or configuration that cannot be solved using the Microsoft Pool of agents as they are selected at random and the only known quantity about them is that they will be selected from a pool that is in the same region as your DevOps Organisation."><meta property="og:title" content="How to Troubleshoot Azure Self-Hosted Devops Agent issues"><meta property="og:description" content="Why Use Self-Hosted Agents for Devops jobs? We recently had issues with some Devops tasks queuing. This was happening only with the tasks in the job that we run on our self-hosted agents.
Why run our own agents? It&rsquo;s a reasonable question. Microsoft provide agents (VMs) pre-configured and ready to run your tasks for you, so why mess about setting up your own?
There is usually a problem or configuration that cannot be solved using the Microsoft Pool of agents as they are selected at random and the only known quantity about them is that they will be selected from a pool that is in the same region as your DevOps Organisation."><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2022-09-05-devopsagenttroubleshooting/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-05T09:00:00+00:00"><meta property="article:modified_time" content="2022-09-05T09:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>How to Troubleshoot Azure Self-Hosted Devops Agent issues</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Sep 5, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://www.chrisneale.org/tags/azure/>Azure</a>
<a class=tag href=https://www.chrisneale.org/tags/devops/>Devops</a>
<a class=tag href=https://www.chrisneale.org/tags/troubleshooting/>Troubleshooting</a>
<a class=tag href=https://www.chrisneale.org/tags/selfhosted/>Selfhosted</a>
<a class=tag href=https://www.chrisneale.org/tags/agent/>Agent</a>
<a class=tag href=https://www.chrisneale.org/tags/fix/>Fix</a></div></div></header><div class=post-content><p><img src=/public/ado.jpg alt></p><h1 id=why-use-self-hosted-agents-for-devops-jobs>Why Use Self-Hosted Agents for Devops jobs?</h1><p>We recently had issues with some Devops tasks queuing. This was happening only with the tasks in the job that we run on our self-hosted agents.<br>Why run our own agents? It&rsquo;s a reasonable question. Microsoft provide agents (VMs) pre-configured and ready to run your tasks for you, so why mess about setting up your own?<br>There is usually a problem or configuration that cannot be solved using the Microsoft Pool of agents as they are selected at random and the only known quantity about them is that they will be selected from a pool that is in the same region as your DevOps Organisation. That&rsquo;s fine if everything you&rsquo;re doing is &ldquo;public&rdquo; and just requires access to publicly available APIs and URLs such as the Azure Resource Manager or other 3rd party https links.<br>However part of our pipeline deploys a container to a private AKS cluster. As soon as you make the cluster private, you can no longer send API calls to the Kubernetes control plane unless you are on a known network which has been given access to the cluster via firewall/NSGs etc.
So it is much easier to create a VM inside the subscription alongside the AKS cluster to run DevOps jobs against.</p><h1 id=why-are-my-self-hosted-jobs-failing>Why are my self-hosted jobs failing?</h1><p>If you find tasks inside a job/pipeline are failing and they are only on your self-hosted agents. You should check your self hosted agent pool.
You can do this by going to your Project Settings>Pipelines>Agent Pools and select your self-hosted agent pool. This will show you the status of each agent.<br>It is likely that one or more (depending on your setup) is showing as offline.</p><h1 id=why-is-my-agent-showing-offline>Why is my agent showing offline?</h1><p><img src=/public/agentpool2.png alt></p><p>It can be a number of reasons. To query the status of the agent you need to log on to the VM itself and query the service.<br>We run our agent on Ubuntu, so after SSH-ing in you need to change directory to the home folder for the agent user, e.g.
/home/myDevopsUser/ADOAgent<br>From here you need to query the service</p><pre tabindex=0><code>sudo ./svs.sh status -l
</code></pre><p>This will show you the status and the tail end of the log so you can look for obvious issues.<br>In our case it was complaining about not being able to reach the devops url <strong>&ldquo;Attempt 1 of GET request to <a href=https://dev.azure.com>https://dev.azure.com</a> failed&rdquo;</strong><br>This made us look at name resolution and found that DNS was failing to resolve names on the VM.<br>Everything in the resolv.conf and other areas pointed to DNS working fine. There were no NSGs or firewalls configured.
A simple reboot of the VM resolved the Name Resolution problem, and also auto-upgraded the agent to the latest release.
If you are having other issues, specific to the agent, you can try stopping and starting the agent with the same script</p><pre tabindex=0><code>sudo ./svs.sh stop
sudo ./svs.sh start
</code></pre><p>You can then query the status again and you should get a service running with no errors in the log.</p><p><img src=/public/agentstatus.png alt></p><h1 id=fixed-andor-upgrading-agents-in-the-portal>Fixed and/or upgrading agents in the portal</h1><p><img src=/public/agentpool1.jpg alt=image></p><p>Once your agent is fixed you will see it showing as &ldquo;Online&rdquo; and the version will be the latest.<br>You should now be able to run tasks/jobs utilising your Self-Hosted Agent again.<br>Normally agents update automatically (for minor versions). If your agents have not updated, you can click on &ldquo;Update all agents&rdquo; in the top right.</p></div><div class=post-footer></div></article></main></body></html>