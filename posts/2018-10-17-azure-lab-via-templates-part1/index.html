<!doctype html><html lang=en-us><head><title>Building an Azure lab environment via ARM templates - Part1 ARM Templates 101 // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=https://www.chrisneale.org/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Building an Azure lab environment via ARM templates - Part1 ARM Templates 101"><meta name=twitter:description content="Aim This post will show you how the format of ARM templates and how to deploy the simplest one without parameters or variables via the Portal, Powershell, AZ CLI.
Pre-reqs You&rsquo;ll need:
An Azure account The latest Azure Powershell. Install instructions can be found here (https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-6.10.0) Your preferred Code Editor, I mostly use Notepad++ ARM Template Format As you&rsquo;ll see shortly the format of an ARM template is relatively simple."><meta property="og:title" content="Building an Azure lab environment via ARM templates - Part1 ARM Templates 101"><meta property="og:description" content="Aim This post will show you how the format of ARM templates and how to deploy the simplest one without parameters or variables via the Portal, Powershell, AZ CLI.
Pre-reqs You&rsquo;ll need:
An Azure account The latest Azure Powershell. Install instructions can be found here (https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-6.10.0) Your preferred Code Editor, I mostly use Notepad++ ARM Template Format As you&rsquo;ll see shortly the format of an ARM template is relatively simple."><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2018-10-17-azure-lab-via-templates-part1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-17T10:00:00+00:00"><meta property="article:modified_time" content="2018-10-17T10:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Building an Azure lab environment via ARM templates - Part1 ARM Templates 101</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Oct 17, 2018</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>6 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://www.chrisneale.org/tags/azure/>Azure</a>
<a class=tag href=https://www.chrisneale.org/tags/template/>Template</a>
<a class=tag href=https://www.chrisneale.org/tags/automation/>Automation</a></div></div></header><div class=post-content><img style=float:top src=https://msdnshared.blob.core.windows.net/media/2017/05/2017-05-06-Azure-IaC-How-to-get-started-with-ARM-Template.jpg><h2 id=aim>Aim</h2><p>This post will show you how the format of ARM templates and how to deploy the simplest one without parameters or variables via the Portal, Powershell, AZ CLI.</p><h2 id=pre-reqs>Pre-reqs</h2><p>You&rsquo;ll need:</p><ul><li>An Azure account</li><li>The latest Azure Powershell. Install instructions can be found here (<a href="https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-6.10.0">https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-6.10.0</a>)</li><li>Your preferred Code Editor, I mostly use Notepad++</li></ul><h2 id=arm-template-format>ARM Template Format</h2><p>As you&rsquo;ll see shortly the format of an ARM template is relatively simple. It&rsquo;s a declarative tool, which means that you are saying &ldquo;I want these resources created, go do&rdquo;. It&rsquo;s not a procedural language where the first thing in your file gets created first (unless you use dependencies which we&rsquo;ll get to later).
Here&rsquo;s a completely empty ARM template</p><pre tabindex=0><code>{
    &#34;$schema&#34;: &#34;http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&#34;,
    &#34;contentVersion&#34;: &#34;&#34;,
    &#34;parameters&#34;: {  },
    &#34;variables&#34;: {  },
    &#34;functions&#34;: [  ],
    &#34;resources&#34;: [  ],
    &#34;outputs&#34;: {  }
}
</code></pre><p>Revolutionary right! Well it&rsquo;s good to look at an empty template as it helps us understand what we&rsquo;re giving ARM to do.</p><ol><li>A list of parameters. These could be things like a name for a VM, or the IP range for a vNet e.g. 10.0.0.0/8</li><li>A list of variables, this is where you could set things like a variable called &ldquo;myLocation&rdquo; based on the Resource Group you are deploying to, or maybe you want to take the users&rsquo; name for a VM and add &ldquo;-VM&rdquo; to the end. We&rsquo;ll see how to do that in a later post.</li><li>A list of functions, these are relatively new but could be used to generate unique names with a prefix.</li><li>A list of resources. This is the key section this is where the magic happens and where you tell ARM what things you want, and sometimes in which order. e.g. a VPN gateway can&rsquo;t be deployed until you have a Public IP. We&rsquo;ll see how we tell ARM to wait on other resources in a later post.</li><li>Finally outputs. In the portal, this is just a nice to see list. In Powershell, CLI or using a &ldquo;Nested&rdquo; template, it means you can pass values out of the end result of a template deployment to be used by another process, even another template.</li></ol><h2 id=steps-to-create-your-first-template-via-the-portal>Steps to create your first template via the portal</h2><ol><li>Log in to Azure and click &ldquo;Create a Resource&rdquo;<br><img style=float:bottom src=/public/labpost1.png></li><li>Type &ldquo;template&rdquo; in the search box and select &ldquo;Template Deployment&rdquo; and click &ldquo;Create&rdquo;<br><img style=float:bottom src=/public/labpost2.png></li><li>Select &ldquo;Build your own template in the editor&rdquo;<br><img style=float:bottom src=/public/labpost3.png></li><li>Now you&rsquo;ll see you have a blank templates (and no variables,functions or outputs section&mldr;which is fine)<br><img style=float:bottom src=/public/labpost4.png></li><li>Select &ldquo;Add Resource&rdquo; and choose &ldquo;Virtual Network&rdquo; from the drop down and enter a name for your vNet and click OK<br><img style=float:bottom src=/public/labpost5.png></li></ol><p>Now woosh, there you have it, your first template to deploy a vNet. You can see on the left 1 resource and 5 variables&mldr;..but wait, you didn&rsquo;t define any variables? No Azure did as it&rsquo;s best practice and makes it easy to edit later and change or even parameterise.
Your template should look identical to this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;$schema&#34;</span>: <span style=color:#e6db74>&#34;https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentVersion&#34;</span>: <span style=color:#e6db74>&#34;1.0.0.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;parameters&#34;</span>: {},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;resources&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;MyLab-vNet&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;Microsoft.Network/virtualNetworks&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;[resourceGroup().location]&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;apiVersion&#34;</span>: <span style=color:#e6db74>&#34;2015-06-15&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;dependsOn&#34;</span>: [],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;tags&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;displayName&#34;</span>: <span style=color:#e6db74>&#34;MyLab-vNet&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;addressSpace&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;addressPrefixes&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetPrefix&#39;)]&#34;</span>
</span></span><span style=display:flex><span>                    ]
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;subnets&#34;</span>: [
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetSubnet1Name&#39;)]&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;addressPrefix&#34;</span>: <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetSubnet1Prefix&#39;)]&#34;</span>
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    },
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetSubnet2Name&#39;)]&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;addressPrefix&#34;</span>: <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetSubnet2Prefix&#39;)]&#34;</span>
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;variables&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetPrefix&#34;</span>: <span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetSubnet1Name&#34;</span>: <span style=color:#e6db74>&#34;Subnet-1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetSubnet1Prefix&#34;</span>: <span style=color:#e6db74>&#34;10.0.0.0/24&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetSubnet2Name&#34;</span>: <span style=color:#e6db74>&#34;Subnet-2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetSubnet2Prefix&#34;</span>: <span style=color:#e6db74>&#34;10.0.1.0/24&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We could deploy that but I want to make this the simplest template ever so I&rsquo;m going to delete the 2 variables referring to subnet 2 and the section under resources/subnets to ditch the second subnet. I&rsquo;ve also removed the depends on statement as it&rsquo;s redundant here.
Your Template code should now look neater and easy enough to read.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;$schema&#34;</span>: <span style=color:#e6db74>&#34;https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentVersion&#34;</span>: <span style=color:#e6db74>&#34;1.0.0.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;parameters&#34;</span>: {},
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;resources&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;MyLab-vNet&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;Microsoft.Network/virtualNetworks&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;location&#34;</span>: <span style=color:#e6db74>&#34;[resourceGroup().location]&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;apiVersion&#34;</span>: <span style=color:#e6db74>&#34;2015-06-15&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;tags&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;displayName&#34;</span>: <span style=color:#e6db74>&#34;MyLab-vNet&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;addressSpace&#34;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&#34;addressPrefixes&#34;</span>: [
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetPrefix&#39;)]&#34;</span>
</span></span><span style=display:flex><span>                    ]
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;subnets&#34;</span>: [
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetSubnet1Name&#39;)]&#34;</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>                            <span style=color:#f92672>&#34;addressPrefix&#34;</span>: <span style=color:#e6db74>&#34;[variables(&#39;MyLab-vNetSubnet1Prefix&#39;)]&#34;</span>
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;variables&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetPrefix&#34;</span>: <span style=color:#e6db74>&#34;10.0.0.0/16&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetSubnet1Name&#34;</span>: <span style=color:#e6db74>&#34;Subnet-1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;MyLab-vNetSubnet1Prefix&#34;</span>: <span style=color:#e6db74>&#34;10.0.0.0/24&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ok, now click the &ldquo;Download&rdquo; above your template code (we&rsquo;re saving it for later to deploy again).<br>Click &ldquo;Save&rdquo; and you&rsquo;ll be taken to the &ldquo;Purchase&rdquo; page. Don&rsquo;t panic&mldr;.vnets are free!<br>Select a subscription and a resource group (or create a new one) and a location to deploy the vnet, tick the &ldquo;I agree&rdquo; box and click purchase.
You can see that it&rsquo;s been submitted if you click the alarm bell near the top left.<br><img style=float:bottom src=/public/labpost6.png><br>Click on the deployment in progress to see more details.
Once it&rsquo;s complete, click on your vnet name to go and see your resource.<br><img style=float:bottom src=/public/labpost7.jpg><br>Amazing! Not really but it&rsquo;s the first Lego brick in your 3000 piece Death Star.</p><h2 id=now-for-powershell>Now for Powershell</h2><ol><li>Open a powershell session</li><li>Change directory to where you downloaded the template in the last section</li><li>Connect to your azure account by typing <strong>Connect-AzureRMAccount</strong> and login as prompted</li><li>Check in the right place by going a <strong>Get-AzureRMResourceGroup -ResourceGroupName BOB</strong> replacing BOB with the resource group you used in the previous section</li><li>Now we&rsquo;re going to deploy our vNet template again so type the following (replacing the RGname with yours and the location of the template file you downloaded to match where you saved yours.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Powershell data-lang=Powershell><span style=display:flex><span>New-AzureRmResourceGroupDeployment -Name LabVnet -ResourceGroupName LabFromTempalte101 -TemplateFile .\Downloads\template.json
</span></span></code></pre></div><p>It completes and you now have 2 vNets&mldr;&mldr;.oh wait, NO you just have the one, the same one you set up before.<br>ARM IS DECLARATIVE. You just told it to &ldquo;make sure I have a vnet called this with these properties&rdquo;. It went and checked, and you have. So it just ended, changing nothing, it didn&rsquo;t recreate our first vnet, it just left it alone.<br><img style=float:bottom src=/public/labpost-powershell.jpg><br>Go edit the template.json file and edit the resources section and change the name, e.g. something like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span><span style=color:#e6db74>&#34;parameters&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {}<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;resources&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;MyLab-vNet10000&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;Microsoft.Network/virtualNetworks&#34;</span>,
</span></span></code></pre></div><p>Save it and re-run the above powershell command.
Once that completes, you can now see you have 2 vNets in the same Resource group.<br><img style=float:bottom src=/public/labpost9.png><br>Fiddly, but in the next lesson we&rsquo;ll deal with parameters.</p><h2 id=summary>Summary</h2><ul><li>You logged in</li><li>Took the framework empty ARM template, added a resource through the portal, which created some variables.</li><li>You deployed it from the portal and got a new vnet</li><li>You deployed the identical template from powershell and go no new vnet, as a vnet with that name and settings already existed.</li><li>You edited the template (changed the vnet resource name) deployed it again and voila. 2 vNets now.</li><li>REMEMBER ARM IS DECLARATIVE!!!!</li><li>REMEMBER ARM IS DECLARATIVE!!!!</li><li>REMEMBER ARM IS DECLARATIVE!!!!</li></ul></div><div class=post-footer></div></article></main></body></html>