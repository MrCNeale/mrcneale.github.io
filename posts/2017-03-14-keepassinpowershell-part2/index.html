<!doctype html><html lang=en-us><head><title>Leveraging Keepass via Powershell-Part 2 // Chris Neales Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.105.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Leveraging Keepass via Powershell-Part 2"><meta name=twitter:description content="Last time round we did 3 things
Loaded the Keepass DLL/EXEs in so we could call their routines Created an Empty KeePass DB construnct to read an existing DB in to Read in an existing KeePass DB into the pointer created in Step #2 These are common tasks we will need to do multiple times....so??? Yep functions. If you want to see the detail flip back to Part-1 Expand this for details of Function Code Blocks Function Load-KPBinaries { Param ($PathToKeePassFolder) # Check if Keepass DLLs are already loaded If (!"><meta property="og:title" content="Leveraging Keepass via Powershell-Part 2"><meta property="og:description" content="Last time round we did 3 things
Loaded the Keepass DLL/EXEs in so we could call their routines Created an Empty KeePass DB construnct to read an existing DB in to Read in an existing KeePass DB into the pointer created in Step #2 These are common tasks we will need to do multiple times....so??? Yep functions. If you want to see the detail flip back to Part-1 Expand this for details of Function Code Blocks Function Load-KPBinaries { Param ($PathToKeePassFolder) # Check if Keepass DLLs are already loaded If (!"><meta property="og:type" content="article"><meta property="og:url" content="https://www.chrisneale.org/posts/2017-03-14-keepassinpowershell-part2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-14T22:00:00+00:00"><meta property="article:modified_time" content="2017-03-14T22:00:00+00:00"></head><body><header class=app-header><a href=https://www.chrisneale.org/><img class=app-header-avatar src=/images/avatar.jpg alt="John Doe"></a>
<span class=app-header-title>Chris Neales Blog</span><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Leveraging Keepass via Powershell-Part 2</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Mar 14, 2017</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://www.chrisneale.org/tags/powershell/>PowerShell</a>
<a class=tag href=https://www.chrisneale.org/tags/security/>Security</a>
<a class=tag href=https://www.chrisneale.org/tags/scripting/>Scripting</a></div></div></header><div class=post-content><p>Last time round we did 3 things</p><ol><li>Loaded the Keepass DLL/EXEs in so we could call their routines</li><li>Created an Empty KeePass DB construnct to read an existing DB in to</li><li>Read in an existing KeePass DB into the pointer created in Step #2</li></ol>These are common tasks we will need to do multiple times....so??? Yep functions. If you want to see the detail flip back to Part-1<div class=edit-comment-hide><details><summary>Expand this for details of Function Code Blocks</summary><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Function</span> <span style=color:#66d9ef>Load</span><span style=color:#f92672>-</span><span style=color:#66d9ef>KPBinaries</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Param</span> ($PathToKeePassFolder)
</span></span><span style=display:flex><span>  	<span style=color:#75715e># Check if Keepass DLLs are already loaded</span>
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>If</span> (<span style=color:#f92672>!</span> (<span style=color:#66d9ef>Test</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Path</span> $PathToKeePassFolder)) { $log<span style=color:#f92672>.</span>WritePSError(<span style=color:#e6db74>&#34;KeePass software could not be located in $($PathToKeePassFolder)&#34;</span>); <span style=color:#66d9ef>Return</span> $null }
</span></span><span style=display:flex><span>	  <span style=color:#75715e>#Load .NET binaries in the folder</span>
</span></span><span style=display:flex><span>  	(<span style=color:#66d9ef>Get</span><span style=color:#f92672>-</span><span style=color:#66d9ef>ChildItem</span> <span style=color:#f92672>-</span>recurse $PathToKeePassFolder<span style=color:#f92672>|</span><span style=color:#66d9ef>Where</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> {($_<span style=color:#f92672>.</span>Extension <span style=color:#f92672>-</span><span style=color:#66d9ef>EQ</span> <span style=color:#e6db74>&#34;.dll&#34;</span>) <span style=color:#f92672>-</span><span style=color:#f92672>or</span> ($_<span style=color:#f92672>.</span>Extension <span style=color:#f92672>-</span>eq <span style=color:#e6db74>&#34;.exe&#34;</span>)} <span style=color:#f92672>|</span> <span style=color:#66d9ef>ForEach</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> { $AssemblyName<span style=color:#f92672>=</span>$_<span style=color:#f92672>.</span>FullName; <span style=color:#66d9ef>Try</span> {<span style=color:#f92672>[</span><span style=color:#66d9ef>Reflection</span><span style=color:#f92672>.</span>Assembly<span style=color:#f92672>]::</span><span style=color:#66d9ef>LoadFile</span>($AssemblyName) } <span style=color:#66d9ef>Catch</span>{ }} ) <span style=color:#f92672>|</span> out<span style=color:#f92672>-</span>null
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Function</span> <span style=color:#66d9ef>Open</span><span style=color:#f92672>-</span><span style=color:#66d9ef>KPDB</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>Param</span> ($PathToKPDB, $KPMasterPassword)
</span></span><span style=display:flex><span>	$MyKPDatabase <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span><span style=color:#f92672>-</span>object <span style=color:#66d9ef>KeePassLib</span><span style=color:#f92672>.</span>PwDatabase 
</span></span><span style=display:flex><span>	<span style=color:#75715e>#Create Password Object</span>
</span></span><span style=display:flex><span>	$MyKPKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span><span style=color:#f92672>-</span>object <span style=color:#66d9ef>KeePassLib</span><span style=color:#f92672>.</span>Keys<span style=color:#f92672>.</span>CompositeKey
</span></span><span style=display:flex><span>	$MyKPKey<span style=color:#f92672>.</span>AddUserKey((<span style=color:#66d9ef>New</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> <span style=color:#66d9ef>KeePassLib</span><span style=color:#f92672>.</span>Keys<span style=color:#f92672>.</span>KcpPassword($KPMasterPassword)));
</span></span><span style=display:flex><span>	<span style=color:#75715e>#Create pointer to file on disk object</span>
</span></span><span style=display:flex><span>	$IOConnectionInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>New</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> <span style=color:#66d9ef>KeePassLib</span><span style=color:#f92672>.</span>Serialization<span style=color:#f92672>.</span>IOConnectionInfo
</span></span><span style=display:flex><span>	$IOCOnnectionInfo<span style=color:#f92672>.</span>Path <span style=color:#f92672>=</span> $PathToKPDB
</span></span><span style=display:flex><span>	$KPNStatusLogger <span style=color:#f92672>=</span> <span style=color:#66d9ef>New</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> <span style=color:#66d9ef>KeePassLib</span><span style=color:#f92672>.</span>Interfaces<span style=color:#f92672>.</span>NullStatusLogger
</span></span><span style=display:flex><span>	<span style=color:#75715e>#open up the Database, using the Open function of the MyKPDatabase object we created earlier</span>
</span></span><span style=display:flex><span>	$MyKPDatabase<span style=color:#f92672>.</span>Open($IOCOnnectionInfo,$MyKPKey,$KPNStatusLogger)
</span></span><span style=display:flex><span>	$KPEntries <span style=color:#f92672>=</span> $MyKPDatabase<span style=color:#f92672>.</span>RootGroup<span style=color:#f92672>.</span>GetObjects($true, $true)
</span></span><span style=display:flex><span>	$KpFound<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>@</span>()
</span></span><span style=display:flex><span>	foreach($KPEntry <span style=color:#66d9ef>in</span> $KPEntries)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		$KPFoundEntry <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Select</span><span style=color:#f92672>-</span><span style=color:#66d9ef>Object</span> <span style=color:#66d9ef>Title</span>,<span style=color:#66d9ef>UserName</span>,<span style=color:#66d9ef>Password</span>
</span></span><span style=display:flex><span>		$KPFoundEntry<span style=color:#f92672>.</span>Title <span style=color:#f92672>=</span> $KPEntry<span style=color:#f92672>.</span>Strings<span style=color:#f92672>.</span>ReadSafe(<span style=color:#e6db74>&#34;Title&#34;</span>)
</span></span><span style=display:flex><span>		$KPFoundEntry<span style=color:#f92672>.</span>UserName <span style=color:#f92672>=</span> $KPEntry<span style=color:#f92672>.</span>Strings<span style=color:#f92672>.</span>ReadSafe(<span style=color:#e6db74>&#34;UserName&#34;</span>)
</span></span><span style=display:flex><span>		$KPFoundEntry<span style=color:#f92672>.</span>Password <span style=color:#f92672>=</span> $KPEntry<span style=color:#f92672>.</span>Strings<span style=color:#f92672>.</span>ReadSafe(<span style=color:#e6db74>&#34;Password&#34;</span>)
</span></span><span style=display:flex><span>		$KPFound <span style=color:#f92672>+=</span> $KPFoundEntry
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	$MyKPDatabase<span style=color:#f92672>.</span>Close()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>Return</span> $KPFound
</span></span><span style=display:flex><span>}</span></span></code></pre></div></details></div><div class=post-footer></div></article></main></body></html>