<!doctype html>
<html lang="en-us">
  <head>
    <title>The iSCSI Mystery (&#43;Death to e1000s) // Chris Neales Blog</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.105.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://www.chrisneale.org/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The iSCSI Mystery (&#43;Death to e1000s)"/>
<meta name="twitter:description" content="I was asked to look at an issue recently with bad IO performance on an SQL VM. SQLio tests were being run and the figures coming back were much lower than expected. There was a little bit of CPU Ready but only occasionally, and the environment was slightly overcommitted. However, after some quick investigation windows task manager showed that the iSCSI traffic was going over the Production Virtual NIC!?!?!
The VM had 2 NICs."/>

    <meta property="og:title" content="The iSCSI Mystery (&#43;Death to e1000s)" />
<meta property="og:description" content="I was asked to look at an issue recently with bad IO performance on an SQL VM. SQLio tests were being run and the figures coming back were much lower than expected. There was a little bit of CPU Ready but only occasionally, and the environment was slightly overcommitted. However, after some quick investigation windows task manager showed that the iSCSI traffic was going over the Production Virtual NIC!?!?!
The VM had 2 NICs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.chrisneale.org/posts/2015-08-11-the-iscsi-mystery/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-08-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-08-11T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://www.chrisneale.org/"><img class="app-header-avatar" src="/avatar.jpg" alt="John Doe" /></a>
      <span class="app-header-title">Chris Neales Blog</span>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">The iSCSI Mystery (&#43;Death to e1000s)</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Aug 11, 2015
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>I was asked to look at an issue recently with bad IO performance on an SQL VM.  SQLio tests were being run and the figures coming back were much lower than expected. There was a little bit of CPU Ready but only occasionally, and the environment was slightly overcommitted.  However, after some quick investigation windows task manager showed that the iSCSI traffic was going over the Production Virtual NIC!?!?!</p>
<p>The VM had 2 NICs.  One for Production traffic and one for iSCSI, connected to different networks and only the Production NIC had a default gateway set.  However the iSCSI Filer IP was on the same subnet as the iSCSI NIC (accessed using a Microsoft iSCSI Initiator) so why wasn&rsquo;t traffic routing down that NIC?  There was no overlap so I ran a
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>route print</span></span></code></pre></div>
Here&rsquo;s where I went down some rabbit holes and fixed some issues.</p>
<p>The routing table showed that the default gateway had a lower Metric than the NIC that was on the same subnet.  I thought this was the issue initially so I set about trying to get the Metric for the iSCSI connected NIC lower.</p>
<p>I learned some things about how Windows 2012 Automatically works out metrics for NICs.</p>
<!-- raw HTML omitted -->
<p>It was then that I spotted something I had taken for granted&hellip;.the virtual NIC types were differet.  Somehow this VM had been configured wrong by whoever added the iSCSI NIC and they had selected e1000 !!!<!-- raw HTML omitted -->
Changing the NIC type to VMXNet3 meant the line rate jumped up to 10Gbps from 1Gbps and now the Metric for the iSCSI nic was the same as the Production default gateway&hellip;but not lower.</p>
<p>I tried manually editing the Production NIC&rsquo;s default gateway metric to add 300 to it to make it higher.<br>
This did make the routing table look right from a metrics perspective&hellip;.but still the traffic went over the Production NIC.  Thankfully after bouncing the issue off a few colleagues one did come back with a config guide for Microsoft iSCSI Initiator on 2012.  <!-- raw HTML omitted -->
Now I hadn&rsquo;t configured the initiator either, we have a storage team who did that.  They had just left some settings default, and it appears that iSCSI ignores your IPv4 Routing Table in Windows.  So all my fidgetting above was in vain (although it did highlight the build issue with e1000 vs VMXNet3).</p>
<p>Microsoft&rsquo;s guide does state
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">If</span> you want to dedicate iSCSI traffic to a specific set of the <span style="color:#66d9ef">NICs</span>, you can specify that <span style="color:#66d9ef">in</span> the <span style="color:#960050;background-color:#1e0010">“</span><span style="color:#66d9ef">Connect</span> using<span style="color:#960050;background-color:#1e0010">”</span><span style="color:#f92672">.</span> <span style="color:#66d9ef">By</span> default, any <span style="color:#66d9ef">IPs</span> can be used <span style="color:#66d9ef">for</span> iSCSI connection<span style="color:#f92672">.</span></span></span></code></pre></div></p>
<!-- raw HTML omitted -->
<p>In Summary</p>
<!-- raw HTML omitted -->
<p>I hope that saves you the morning I had!</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
