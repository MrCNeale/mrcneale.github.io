<!doctype html>
<html lang="en-us">
  <head>
    <title>Troubleshooting Azure VM Extension Installation Failures // Chris Neales Blog</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.105.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://www.chrisneale.org/css/main.min.0fb49e70a30412f97ddfc418e18fefef1d9fcdebe45f634dbbba768b00fe1eec.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Troubleshooting Azure VM Extension Installation Failures"/>
<meta name="twitter:description" content="What can you do to find out more about why a VM extension is failing or not working quite right? Azure VMs are great and VM extensions are even better. Either a Vendor, or you, can create some code to do a thing to a VM. Usually install software or agents and configure it. Most common for the average user will be things like the Log Analytics Agent Extension and the Custom Script Extension (where you can run your own Powershell or Bash post install)."/>

    <meta property="og:title" content="Troubleshooting Azure VM Extension Installation Failures" />
<meta property="og:description" content="What can you do to find out more about why a VM extension is failing or not working quite right? Azure VMs are great and VM extensions are even better. Either a Vendor, or you, can create some code to do a thing to a VM. Usually install software or agents and configure it. Most common for the average user will be things like the Log Analytics Agent Extension and the Custom Script Extension (where you can run your own Powershell or Bash post install)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.chrisneale.org/posts/2019-06-12-troubleshootingazurevmextensionfailues/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-06-12T22:00:00+00:00" />
<meta property="article:modified_time" content="2019-06-12T22:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://www.chrisneale.org/"><img class="app-header-avatar" src="/avatar.jpg" alt="John Doe" /></a>
      <span class="app-header-title">Chris Neales Blog</span>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vehicula turpis sit amet elit pretium.</p>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Troubleshooting Azure VM Extension Installation Failures</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jun 12, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          2 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://www.chrisneale.org/tags/arm/">ARM</a>
              <a class="tag" href="https://www.chrisneale.org/tags/template/">Template</a>
              <a class="tag" href="https://www.chrisneale.org/tags/troubleshooting/">Troubleshooting</a>
              <a class="tag" href="https://www.chrisneale.org/tags/azure/">Azure</a>
              <a class="tag" href="https://www.chrisneale.org/tags/extensions/">Extensions</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <img src="/images/vm.png">   
<h1 id="what-can-you-do-to-find-out-more-about-why-a-vm-extension-is-failing-or-not-working-quite-right">What can you do to find out more about why a VM extension is failing or not working quite right?</h1>
<p>Azure VMs are great and VM extensions are even better.  Either a Vendor, or you, can create some code to do a thing to a VM.  Usually install software or agents and configure it.
Most common for the average user will be things like the Log Analytics Agent Extension and the Custom Script Extension (where you can run your own Powershell or Bash post install).
Oh&hellip;and the AD Domain Join extension for Windows VMs.</p>
<p>So I&rsquo;m going to work on the presumption you&rsquo;ve copied a quickstart template</p>
<p><a href="https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-domain-join-existing">https://github.com/Azure/azure-quickstart-templates/tree/master/201-vm-domain-join-existing</a> or written your own template or manually added an Extension via Portal&gt;VM&gt;Extensions&gt;Add say for the Symantec Cloud AV extension.</p>
<p>You run the install or deploy the template, but you get a failure.  I&rsquo;m willing to bet the deployment message is cryptic and not very useful, especially for Domain Join.<br>
<img src="/images/faileddep.png">   <img src="/images/failedop.png"><br>
So you can log in to the VM and start looking in the event log for clues, but that&rsquo;s more effort than I can be bothered with trawling for.</p>
<p>What&rsquo;s the alternative?<br>
Well every extension installed downloads to a particular folder.<br>
C:\Packages\Plugins&lt;extension name&gt;<br>
e.g. for Domain Join it&rsquo;s C:\Packages\Plugins\Microsoft.Compute.JsonADDomainExtension\1.3.2
Every installation of an extension creates a log in another folder.<br>
e.g. C:\WindowsAzure\Logs\Plugins\Microsoft.Compute.JsonADDomainExtension\1.3.2<br>
So the first 2 easy steps are</p>
<ol>
<li>Confirm the contents of the install folder look good (if this is a custom script, you&rsquo;ll know best, if it&rsquo;s 3rd party, it may not be clear)<br>
<img src="/images/installfolder.png"></li>
<li>Next look at the logs sub-folder named after your extension and review the logs for more detail.<br>
What we can see is that it fails and throws error 1355<br>
Which good old eventid.net tells us is a connection failure (coz bob.com doesn&rsquo;t exist or is resolvable on my vnet)<br>
<a href="http://www.eventid.net/errorsdisplay.asp?error_code=1355">http://www.eventid.net/errorsdisplay.asp?error_code=1355</a><br>
<img src="/images/installlog.png" width="1365" height="498">(/images/installog.png) <br>
There you have it. How to drill down inside a VM to find issues with installs of Microsoft, 3rd Party or your own CustomScript Extensions.</li>
</ol>
<p>NOTE: For linux the folders are<br>
Logs = /var/log/azure/<br>
Install = (this runs in the cwd of where it&rsquo;s downloaded) so search the filesystem for PackagesDirectory</p>
<h2 id="links">Links</h2>
<p>AD Domain Join Extension
<a href="https://blogs.msdn.microsoft.com/igorpag/2016/01/25/azure-arm-vm-domain-join-to-active-directory-domain-with-joindomain-extension/">https://blogs.msdn.microsoft.com/igorpag/2016/01/25/azure-arm-vm-domain-join-to-active-directory-domain-with-joindomain-extension/</a>
Log Analytics Agent VM Extension<br>
[https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/oms-windows(https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/oms-windows)
<a href="https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/oms-linux">https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/oms-linux</a>
Custom Script Extension<br>
<a href="https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/custom-script-windows">https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/custom-script-windows</a>
<a href="https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/custom-script-linux">https://docs.microsoft.com/en-gb/azure/virtual-machines/extensions/custom-script-linux</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
